#!/usr/bin/env python

import alerter
import os
import re
import subprocess
import socket
import time

CONF = alerter.config.CONF
LOG = alerter.log.LOG
ALERTER = alerter.alert.ALERTER


def get_dispersion():
    devnull = open(os.devnull, 'w')
    obj_dispersion = 100.0
    con_dispersion = 100.0
    
    for line in subprocess.check_output(['swift-dispersion-report'], stderr=devnull).split('\n'):
        matchdata = re.match('^([0-9\.]+)% of container.*$', line)
        if matchdata:
            con_dispersion = int(float(matchdata.group(1)))

        matchdata = re.match('^([0-9\.]+)% of object.*$', line)
        if matchdata:
            obj_dispersion = int(float(matchdata.group(1)))

    return obj_dispersion, con_dispersion

try:
    host = socket.gethostname()
    interval = CONF.get('interval', 300)

    o, c = get_dispersion()

    print 'PUTVAL "%s/swift-dispersion/gauge-container" interval=%d %d:%d' % (
        host, interval, int(time.time()), c)

    print 'PUTVAL "%s/swift-dispersion/gauge-object" interval=%d %d:%d' % (
        host, interval, int(time.time()), o)

    if o != 100 or c != 100:
        ALERTER.failure('dispersion', 'dispersion failure', description='low dispersion: %d%%/%d%%' % (o, c))
except Exception as e:
    ALERTER.failure('dispersion', 'dispersion monitor exploded',
                    description='Monitoring script died: %s' % str(e))

time.sleep(interval)


            
            

 
